const _ = require('lodash');

const input = `>>><<<>>>><<<>><<<<><>>><>>>><<><<<>>><<<><<<>>>><<<<>>><<>>>><<<>>>><<<<><>>>><<<>><<<>>><<><<<><>>>><>>>><<><<<<>>><<>>>><<<<>><<<<><<<>>><<<>><<<>><>>><<<<>>><<>>><<><<<<>>>><<<<><<<<>>><<>><<><<><<>>><<<><<<<>>>><<<><<<><><<><>>><<<<>><<<<>>>><><<<<>><>>>><<<<>>><<<>>>><<<<>>>><<<><>>>><>>>><<>>><<>>>><>>>><<><<<<>>><>>>><>>>><<<<>><<<>><<><<><<<><<><>><<<><<><<>>>><<>>><<>>>><>>><<<<>>>><<>><<<<><<>><><<<>><<<>>><<>>><<<><<<<><<>>><<<><<<<>>><<><<<<><<<<>><<<>><><>>>><><<<>>><<<>><<<<>>>><><<<<><<<>><<><<<>>>><<><<<>>>><<>>>><><>>><<>>><<<>>>><<<><<<><<<<>>><<<>>>><<<><>>>><<>>>><<<>>><<<<>><<<<>>>><><<<>>><<<<>>>><><>>>><>><>><<<>>><<<<><<<<><<<<>>>><<<>>>><>>>><<<<>>>><<>>><<><<<><<<><<<>>><<<>><<<><<<>>>><<<>><<>><<><<>><<<<>><<<<>><>><<>><<<<>>>><><<<<>><>><><<<>>><<<<>><>>>><<>>>><>><>>><<>><<><<<<>>><<<>>><>>><<><>>><<<<><><<<>>>><<<<><<<>>><><<<<><><<>>><<<><><><<>>><><><<>>>><<<>>>><<<>>><<>>>><>>><<<<>>>><>>>><<><<<>>><<<>>>><<>><<<<>>>><<<<>>><<<<><<<>><<>><<>>>><><<<>>>><<<>>>><<<<>><<<<>>>><>>>><<<>>>><><<>><>><<<><><<<<>>>><>>>><<<<>>><<<><<<><<<<>>>><<><<<>>>><<>>><<>><><<>><<<<>>><<>><<<><<<>><<<<><<><<<>>><><>><<<>><<<<>>>><<<>>><<>>><>><>><<<>><<<><<<><<><<>>>><<<<>>>><<<<>><<>><<>><<<>><<><<<><>>><<><>>><<>>>><>>>><><<><>><>><>>>><<<<>>><><<<<>>>><>>>><>>><<<>>>><<><<<<>><<<>>><<>>><<>><<<<>>>><<<>>>><<<>>><<<>>><><<<>><<>>><<<<>>>><>>>><<<>>>><<<>><>><<<>>>><<<>>>><<>>>><<<<>><><>>><<>><<<<><<<<>><<<<>><<<>>>><<<><<>><<>><<<<>><<>>><<<<>>><<<>>><<<<><<<<><<><<<>>>><>>><>>><<>><>>><<<<>>>><<<><>><<><<<<><>><<<><<>>>><<<><<<<>>>><<>>><><>>><<<>>>><><<>><<<>>>><>>>><<>><<<>>><<<<>>><<><>>><>><<<<>><<>>>><<<<>>>><<<>><>><<<>>><<<>>>><<<<><<><>><<<>><<><<<<>>>><<<>>><<><<<<><>><<<><<<><<<<>>><>><<<<><<<>><<<<>><>><<<<><<>><><<<>>><<<<>>><><<<<><>><><<>>>><>>>><<<<>>><<>>><<>>>><<<><<>>><<><<<<>>><<<>>><>><<<<>>><<>><<<>>><<>>>><<>><<<<>>>><<>><<>>>><<>>>><<><<>><<<<>>>><<<<>>><<<<><>>>><<<>>><>>><<<<>>>><<>>><<<><<<><<<<>><>>><<<>>>><<>>><<<>>><<<<>><<<>><<><<<<>>>><>>>><<><>>><<<<><<><<<<><><<<<>>><<><<><<<>>>><<><<>>>><>>><>><<<<><<<>>>><<<<>><<>>><<<>>>><<>>>><<><<>>>><>><><<<<>>>><<><<>>><<><<<><<><>><<<<>>>><<<>>><<<>>>><<><>>>><<><<><<<<><<<<>>><<<><>>>><<<>><<>><<><>>>><<>><>>><<<<>>><<>>>><<<<>>><>>><<<>>>><<<>>>><<<<>>><<>>><>><<<<>><<<><<<>>>><<<><<<<>>><<>><>><<<>><<<>><>>>><<>><><>>><<><>><<<>>><<>>>><>>><<><<>>><<<<>><<<<>>><>>>><<<<>>><<<>><<<<>>><<<><<<>>>><>>>><>><<<<>><><<<><>>>><>>>><<>>><<>>><<>>><<<><<>><<<>>>><>><>><<<<>>>><<>>><<>>>><>>><>><<>>><<<<>>>><<<>><<<><<<><<>>><<>><>>><<>>><<<<>><<<<><<>><<<<>>><<>>><><<>>><<<<>>><<<<>><<<<>><<<>>>><<<>>>><<<<>>><<<><<><<>>><<<>>>><<>>>><<<<>>><<<<>><<><<<<>>><><<<>><>>><<>>><<><<><<><<<<>>><<<><<<<><<<<><<<<>><>><<<<>>>><>>><<<<>><<><<>><<<>><<>>>><<<<>>>><<>><>><<><>>><<>><<<>><<>>><<<>>><<><<<<><><<>><<>>><<<>>>><<<<>>><<><<<>>>><<<<><<<<><>>>><<<>>>><<<>>><>>>><<<<>>>><<<<>><<>>><<>>>><<><<>>><<>>>><<<<><>>><<>>><>>>><<<>>><<<<>><<<<>><<<>><><<>>><<<>>><<<<>>>><<>>><<<<><<<<>>>><<<>>><<<><<>>><>><>>><<<<>>>><>><<<<>><>><<<<>>>><<<>><<>><<<>><<<><<<<>>>><<<<>><>>>><>><<<>>>><>>><>><<<><<<>><<<<>>><<<<>>><<>><<<><<<>>><<<>><<>>><<<<>>><<><<<>>><<><<><<<<>><>><<><<<<>><>>>><<><<<>>><<<>><><<<<>><<<>>>><<<>><<<>>><>><>>><<<>>>><>>><<<><<<>>>><<<>><<>>><>>>><<<<>>><<><<<<><<<>>><<<<>>>><<<<><>><<<><<<<>>><<>>>><<><<><>>>><>>>><<<<>>>><<<<>>><>>>><>><<<>>>><<<>>>><<>>>><<><<<<>>>><<<<><>><<<<><>>><<<>><>><>>>><><<<<><<<>>><<<<>><<<><<<<>>>><<<><<<>>>><><<<>>>><<<>><<<>><<<<>>><<<>>>><<<>>><>><<><<<>>><<>>><<><>><<<>>>><<>>>><<<>>>><<<<>>>><<<>>>><<>><>>>><<<><<>><<<><<<>><><>>><<>><<<><>>><<<>><<<>>>><<><>>><>>>><<<<>>>><<<<>>>><>>><<<<>><<<<><<<>>><>>><>>><<<><><<<>><<<>>><<<>>><<<>>>><<<<>>>><<<<><>>>><<<>><>><<<<>><<><<<<><<<>><><<<<>><>>>><<<<>><<<<><<<>>><<><<<<>>>><>>><<><>><>>>><<>><<<<>><>>>><<>><<>><<<<>><<>>>><<<<>>><><<<>><<<<>>>><<<<>>><<<<><<>><<>><<>>><<><<<<>><<<<>>><<>><<<<>><<<>>><<<>>>><<>>><<>>>><<<>><<<>>><>><<<<>><<<<>>><<>>><>>>><<><<>>>><<<<>>>><<><><<<<>>>><<<<>>>><<<>>>><><>><<>>><<<><<<<>>><><<<<>>><>>><><<>><<<<>>>><<>>><>>><>>><<><<><<>>>><<><<<<>>>><<<>><>>>><<<><><>>><<><<<>>>><<<<>>>><<<<>>><<<<><>><<<<>><<<>>>><<<<><<>>><><>>>><<>>>><<<>>><<<>>>><<<<><<>><<><<<<>>>><<<<>><<<><<>><<<>><<<>>>><<<>>><<<<><<<>>>><<<>>>><<<>>>><><<><<>><<<<><<<>>>><>>><><<<<><<>>>><<<<><<<>><<><<<><<<<>>>><<><<>>><>><<<<><><<<<>>><<<<>><>>><>>>><<><<<<><<<>><<<<>>>><>>>><<<><>>><<<<><<>>><>>>><<>><<>>>><<<<>>>><<<<>><<>><<<>>><<<<>>>><>>>><<><<><<<><<>>>><<><<<<>><<<<>><<<<><<<<><<<<><><<<<>>><<<<>><<><<>>><<<<>><<<<>>>><>><<<>>>><<<<>>>><<>>><<>>><<>>><<<<>>><<<>><>><<<>>><<>><<<<>><<><<<>>>><>>>><>>>><<<><<<>><<<<>>><>>><<>><<<<>>>><>>>><<>>>><>>><<<<>>><>>>><<<>><>>>><<<>>>><>>>><<<>>>><<<>><>>>><<<<>>><><<<><<<>>>><<<<>>><<<>>>><<>>><>>>><<<><<<>><<>>><<<<>>>><<<<>><><<<><<<>><<><>><<<<>><<<>>><<<<>>><<<<><<<><>>>><<>>>><<<<>>><<>>><<<<><>>><<>>>><<>>><<>>>><>>>><<<>>><<<>>>><<<>>><<>>><<>>>><<>>><<<>>>><>>><<<<>>>><>><>><<>>><<>>>><<<>>>><<<>>><<<<>>>><<>>><<<>><><<>><<<<>>><<<<>>><<<<><<>>><<<<>>>><<>>><<<<>>>><<>>>><<>>><<<><<<<><<>>>><<<>><>>>><<<>>><>>><<<<>>>><>>>><<>>><<<<>>>><<<<><<<<>><<><>><<<<><>>>><>>><>><<<>>><<>>>><>>>><<><>><<<<>>>><<<><<<<>>><>>><<<>>><<<<><<>><><><>><>><<<<>><<<>>><>>><<<>><<>>>><<<>>><><<<>><<<><<<<>><>><>><>><>>>><>><><<<<>>><<<<>>>><<<<><<>><>><<>>>><>>>><<<<>>><<<>><>>>><<<>><<<>>>><<>>>><>>>><<>><>>><<<<><<<<>>><<<<>><>><>><<<<>>><>>><<<<><<<>>>><<<>>>><<<<>>>><>><<<>><<<><<<><><>><<<>><>>><<>>>><<<><<>><<<<><<<<><<<>><<<>><<<<><<<><<<<><<<>><<><<<>>><<<<>><><<<<>><<<>>><<<>>>><<>>><<>>>><<>>>><<<<>><<<<>>><>>><>><<><<<<><><<><<<>>>><>>>><<<<>>><<>>><<<>>>><<<<>>><<>>><<<>>><>>>><<<<>><<>>>><<<<>>><<>>><<<<>><><<>><<>>>><<>>><<>>>><<<<>>><<<<>>><><<<><<<<><>>><<<<>><>><<<<>>><<<>><>>>><<<<>>><<>>>><<<<><<><<<<>>><<<<>>>><<>><<<<>>><<><<<>><<<>>><>><<<<>><<<><>><<>><<>><<<<>>>><>>><<>>><<><<<>>>><<<<><>>><<<>>><<<<><<<>><<>>>><<<>>>><<><<>><<>><<<><<<<>>>><<><<<<>><><>>><><<<>>>><<<<><<>><>>><<>><>>><<<><<>>><<<<>><>><<<<>><<<<>>>><<<<><<<<><<<>><>>><<<>>><<<<>>>><<>><<>><<<>>><><<<<><<<<>>>><<<>>><<>>><<>><<<<>>>><<>>><<<><>>><>>><<>>><<>>>><<<<><<<<><<<><<<>><<<<>>><>>><>><><<<<>><<><<>>><>>><<<<>><<><<<<>><<<>>><><<>>><<><<<<>><<<<><<<><>>><<<>>>><<>><<<<>>>><<<>><<<>><<<<>>>><<<>><<<<>><<<>>>><<>><>>><<><<<<>><<>>>><<<>>>><<<>>>><>>><<<<><<<><>><<><<<>>>><>><<<<>>><<<<>>><<<>><<<>>><>>>><<<<>>><<<<>>>><<<<>><<>>><<<><<<<>>><>>><<>>><<<>>>><<<<>><>>>><<<<>>><><<<<><<<>><<<><<<<><<<>><<<<><<>><<<<>><><<<>>><>><<<>><<<><>>><<<<>>><<>>>><<>><<>>>><><>>>><>><<<<><<<<><<<<><><<<<>>>><<>>>><<>>><<>><<<>><<><>>>><<<<><<<><<>>>><<<>>>><<<><<<<>>><<>>><<<<>>><<>>><<<><<><>>>><<>>>><<<<>>>><<<>>>><<<<>>><><>><<>>><<<<>>><<<<>>><<<><<<>>><<<>>>><>><<><<>><>><>><><<<>>><<<<>>>><<<>>>><<<<>>><>><<<><<<<>>><<<<><<<<>>>><<<>>><<>>>><<<>>>><>><<<<><<<<><<<>>><>>>><>>>><<>>>><<<><<<><<<>>><<<<>>><<>>><>>>><<<<>>><<><<>><<<><<<><<<><<<<>>><<<>><<<<>>>><<<<><<<>>><<<><><><<<>>>><<<<>>>><<<<>><<>><<<<><>>><<<>><<>>>><<<>>>><>><<<<><><<>>>><<<>><<<<>><<>>><<<<>><><<<>><<>>>><<>>><<>>>><<<<><<<><<>>>><>>>><<<>>><<<<><<>>>><>>>><>>>><<<<><<>>><<<<><<>>>><<<>><<>><<<<>><<<><<<>><<><<>>><<>><<<<><<<>><>>>><<<<><<<>>>><<<>>>><<<>>>><<<<>>><<<>>><><<<<>>>><<>><<<<>>><<<>>><><>>>><<<>>><<><<><<>>>><<>><<<<>>><<<>>>><<<<>>>><>>><<<<>>>><<<<><<><<>>><<<><>><<><<<><>><<<<><<<>>>><<<<>>>><>>><<<>>><<<<>>><>>><<<<>>>><<<<>>><<<<><>><><<>><<<>>>><<<>><<>><<>>>><<<<>>><<<<>><<<<><<><<>>>><<>>>><<<<>>><<<<>><><<<<>>><<>>><<<<><<<<><<>>>><<>><<><>>>><<<<>>><<<>>><>>>><<<><<<>><<<<>>><<>>><<<<>>><>><<<><<><><<<>><<<><<>>>><<<<><<<><<<<>><<<<>><<>>>><<<<>><<>>>><<>><<<>><<>>>><<<<>>><<<<><>><<<>>>><><>>>><<<><<<>><>>><<>><<<>>><<<<><<<>>><<><><<><>>><<>><<<><>>>><>><<<<>><<<<><<<<>>>><<<>>><<>>>><<>>>><<<><<><<<>>>><>><>><<<>><<<><<>><<<>>>><<>>>><<<<>>>><<<<>>><<<<>>><<<>>><<<<><<<>>>><<>>>><>>><><<<>><<><<<><>>><><>>><<<<>>><<<<><<><<<>><<<<><<<<>>>><<<<>><>>>><<>>><<<<>>>><<>>>><><<>>><<><<>><>>>><><<<>>>><<>>><>>>><>><<<<>>>><<<>>>><>>><<>>>><>>>><<>>><<>>><><<<>>><<<><<<>>><<<<>>><<<><<>>>><>>>><><>>><>><><<>>>><<><>><<>><>>><<><<<>>><>><<<><<<<>><><<>><>><<>>>><<<<><<>>>><<<<><>>><<><>>>><<<><<>><<<<>>><<><<>>><<<>>><<<>>><<<<><<<>>>><<<>><>>>><<><<><<<<>>>><<<<>><<<>>>><<<>>>><<<<>>>><<>><><<<<><<<<><<<<>>>><<>><>><<<<><<<>><<>><<<>>>><>>>><<><<<><>>><<<<><>>><>>>><<<<>>>><<<<>><>><<<<>>><>><<<<>>><<<<>>><>>>><>>><<<>><<<>>><<<>>><>>><<<<>><<><<<>><<<<>>>><<><><<<<>>>><<<<>><<<>><<>>>><<<<><>>><>>>><<<><<<<>><<<>><><<<<>><<<<>>><<<>>>><>>>><>><<>><<>>>><<<<>>>><>>>><<<<>><<<>><<<<><<<<><>>>><<<>>>><<<<>><<>><<<<><>><>>>><><<<<>>>><<<<><<<>>>><<<>>>><<>>>><<<><<><>>><<<<>>><<>><<<<>>><<>>><<<>>>><>>>><<<<>>>><<<><<<<>>><<<<>>><>><><<<<>><<<>><<<>>><<<<><<<>>>><<<>>>><<>>>><<>>>><<<<>>>><>><<>>><<>><<<<><<><><<<<>>><<>>><<<<>>><<>><><<<<>>><<>><<<>>>><<<>>>><<><<<<>><<<>><<<>><><<<<><<><<<>>>><>>>><<<><<>><<<<>><<<<>>><><<<>>>><<>>><<<<>>>><<<>>><<<<>>><<<<>><<<>>><><>><<>><>>>><>>><<<>><>>><>><<>><><>><<>><>><<>><><<>>><<<<>>><<<>>><<>>>><>>><>>><>>><<><<><<<>><>><<>><>>>><>>>><<<><<>>><<>><<<><<>>><<<<>>>><<<>><<<<><<<<><<<<><<<>>>><<<>>>><<<>>><<<>>><<<<>>><>>>><<<<>>>><<<>>>><>>>><>>><<<>>>><<>>><<<>><<<<><<<<>>>><<<<>>><>><<<>><>>>><>>><<>><<<<>>><<<<>>>><><>>><>><>>>><>><>>><<<>>>><><<<>>><<>>>><<<<>>>><<<<>>>><<<<>>><<<<>>><<<<>><<<<>><>>><<>>><<<>>>><<<>>>><>>>><<>>><<<<>>>><><<<><<>>><<<><<>>>><>><<>><<<<>><<><><><><<<>>><<>><<<<>>>><>>>><<<><<<><>>><>>><<>><<<<>><<<>>>><<<><<<<>><<<<>>>><<>><>><><<>>>><<>><<<>>>><>>><<>>>><<<<><>><>>>><<<><<<>>>><>><><>><<<>>><<<<>>>><<>><<<<>>><<<>>><<<>>><<>>>><<<<>>><<<<>>><>><<<<>><>><>>>><<>>><<<<><<<<><<<<><>><<<<>>>><<<>>><<>>>><<<<>><<<<><<<>><>>><<<><<<<>><>><<<<>>><<<<>>><><<<>>><<<<>><<<<><<>>><<>>><<<>>><<<<>>><>><<><<>><<<<>>>><>><<>>>><<<><><<>><><<<<>>><<<>>>><<<<><<<<>>>><>>><>>><>><<<><<<<>>>><<<>>><<<<><<<>>>><<<<>>><<>>><<><<>><<<<>>>><<>>>><<<<>>><<<>>>><<><<<<>><>><<<><<>>>><<<<>>><<>><<<>>><<<<>><<<>><<<<>>><<>>><<<<>><>><<>>>><<<>`;
const example = `>>><<><>><<<>><>>><<<>>><<<><<<>><>><<>>`;

const rocks = [
  [
    0b00011110
  ],
  [
    0b00001000,
    0b00011100,
    0b00001000,
  ],
  [
    0b00000100,
    0b00000100,
    0b00011100,
  ],
  [
    0b00010000,
    0b00010000,
    0b00010000,
    0b00010000,
  ],
  [
    0b00011000,
    0b00011000,
  ],
];

widestRockRows = [
  0,
  1,
  2,
  0,
  0
];

nibbleLookup = [0, 1, 1, 2, 1, 2, 2, 3, 1, 2, 2, 3, 2, 3, 3, 4];

class Aoc17 {
  wind;
  windLen;
  tower = [];
  towerLen = 0;
  windIndex = 0;
  rockIndex = 0;

  constructor(data) {
    this.wind = data;
    this.windLen = data.length;
  }

  collision(rock, towerIndex) {
    const rockHeight = rock.length;
    for (let i = 0; i < rockHeight; i++, towerIndex++) {
      if (towerIndex >= this.towerLen) {
        return false;
      }

      const towerRow = this.tower[towerIndex];
      const rockRow = rock[(rockHeight - i) - 1]
      const nbt = this.numBits(towerRow);
      const nbr = this.numBits(rockRow);
      const nbMerged = this.numBits(towerRow | rockRow);
      if (nbMerged !== (nbt + nbr)) { // collide if less bits after merging
        return true;
      }
    }
    return false;
  }

  getNextWindDir() {
    return this.wind[this.windIndex++ % this.windLen]
  }

  blowRock(rock, rockId, towerIndex = null) {
    const dir = this.getNextWindDir();
    const newRock = _.cloneDeep(rock);
    const widest = newRock[widestRockRows[rockId]];
    const rockHeight = rock.length;

    if (dir === '>') {
      if ((widest & 0x01) !== 0x01) {
        for (let i = 0; i < rockHeight; i++) {
          newRock[i] >>= 1;
        }
      }
    } else {
      if ((widest & 0x40) !== 0x40) {
        for (let i = 0; i < rockHeight; i++) {
          newRock[i] <<= 1;
        }
      }
    }

    if (towerIndex === null) {
      return newRock;
    }

    if (!this.collision(newRock, towerIndex)) {
      return newRock;
    }

    return null;
  }

  numBits(b) {
    return nibbleLookup[b & 0x0F] + nibbleLookup[b >> 4];
  }

  dropRock() {
    const rockId = this.rockIndex++ % 5;
    let rock = _.cloneDeep(rocks[rockId]);
    const rockHeight = rock.length;

    for (let i = 0; i < 4; i++) {
      rock = this.blowRock(rock, rockId);
    }

    let overlap = 0;
    let resting = false;
    while (!resting) {
      if (overlap >= this.towerLen) {
        resting = true;
        break;
      }

      // check if moving it down will crash
      // loop for overlap
      for (let i = 0; i <= overlap; i++) {
        const towerRow = this.tower[this.towerLen - 1 - (overlap - i)];
        const rockRow = rock[(rockHeight - i) - 1]
        const nbt = this.numBits(towerRow);
        const nbr = this.numBits(rockRow);
        const nbMerged = this.numBits(towerRow | rockRow);
        if (nbMerged !== (nbt + nbr)) { // collide if less bits after merging
          resting = true;
          break;
        }
      }

      if (resting) {
        break;
      }

      overlap++;

      const newRock = this.blowRock(rock, rockId, this.towerLen - overlap);
      if (newRock !== null) {
        rock = newRock;
      }
    }


    // place the rock
    for (let i = rockHeight-1; i >= 0; i--, overlap--) {
      if (overlap > 0) {
        this.tower[this.towerLen - overlap] |= rock[i];
      } else {
        this.tower[this.towerLen++] = rock[i];
      }
    }
  }

  dec2bin(dec) {
    return (dec >>> 0).toString(2);
  }

  displayTower() {
    for (let i = this.towerLen-1; i >= 0; i--) {
      console.log(`|${String(this.dec2bin(this.tower[i])).padStart(7, '0')}|`);
    }
  }

  solve() {
    for (let i = 0; i < 2022; i++) {
      this.dropRock();
    }

    console.log(`Part 1: ${this.towerLen}`);

    // this.displayTower();
  }
}

const aoc17 = new Aoc17(example);
aoc17.solve();
